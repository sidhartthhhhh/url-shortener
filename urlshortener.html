<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scalable URL Shortener</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-2xl mx-auto p-4">
        <div class="bg-white rounded-2xl shadow-lg p-6 md:p-10">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900">URL Shortener</h1>
                <p class="text-gray-500 mt-2">A scalable link shortener built on a robust design.</p>
            </header>

            <main>
                <!-- URL Shortening Form -->
                <div class="space-y-4">
                    <div>
                        <label for="longUrl" class="block text-sm font-medium text-gray-700 mb-1">Enter Long URL</label>
                        <input type="url" id="longUrl" placeholder="https://example.com/my-very-long-url-to-shorten" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>
                    <div>
                        <label for="customAlias" class="block text-sm font-medium text-gray-700 mb-1">Custom Alias (Optional)</label>
                        <div class="flex">
                            <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">short.ly/</span>
                            <input type="text" id="customAlias" placeholder="my-awesome-link" class="w-full px-4 py-2 border border-gray-300 rounded-r-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        </div>
                    </div>
                     <div>
                        <label for="expiryDays" class="block text-sm font-medium text-gray-700 mb-1">Expires in (Days, Optional)</label>
                        <input type="number" id="expiryDays" min="1" placeholder="30" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>
                    <button id="shortenBtn" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition transform hover:scale-105">
                        Shorten URL
                    </button>
                </div>

                <!-- Result and Message Display -->
                <div id="result" class="mt-8"></div>

            </main>
        </div>
        
        <footer class="text-center mt-6 text-gray-400 text-sm">
            <p>&copy; 2025 URL Shortener Inc. Sidhartha Singh</p>
        </footer>
    </div>

    <script>
        // --- SIMULATED BACKEND & INFRASTRUCTURE ---
        // This script simulates the backend services described in the system design document.
        // In a real-world application, this logic would live on servers, not in the client's browser.

        // 1. SIMULATED DATABASE (NoSQL Key-Value Store like DynamoDB/Cassandra)
        // The primary key is the `short_code`.
        const db = {
            urls: new Map([
                ['welcome', {
                    longUrl: 'https://en.wikipedia.org/wiki/URL_shortening',
                    createdAt: new Date().toISOString(),
                    expiresAt: null,
                    isCustom: true
                }]
            ]) 
        };

        // 2. SIMULATED CACHING LAYER (Redis/Memcached)
        // Caches frequently accessed short codes.
        const cache = new Map();

        // 3. SIMULATED ID GENERATION SERVICE (Zookeeper-based or Snowflake)
        // This function generates a short, URL-safe, unique ID.
        // This mimics a dedicated service providing unique IDs on demand.
        function generateShortCode() {
            // A simple implementation for demonstration. Real systems use more robust libraries.
            const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 7; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            // Ensure uniqueness by checking the DB
            if (db.urls.has(code)) {
                return generateShortCode(); // Recurse if collision (highly unlikely with 7 chars)
            }
            return code;
        }
        
        // 4. SIMULATED ANALYTICS PIPELINE (Message Queue like Kafka/RabbitMQ)
        // In a real system, this would publish a message to a queue. Here, we just log it.
        function publishAnalyticsEvent(shortCode) {
            const event = {
                shortCode: shortCode,
                timestamp: new Date().toISOString(),
                ipAddress: '192.168.1.1', // Simulated
                userAgent: navigator.userAgent,
                location: 'Bhubaneswar, IN', // Simulated
                type: 'URL_REDIRECT'
            };
            console.log('--- ANALYTICS EVENT PUBLISHED ---', event);
        }

        // --- SIMULATED API SERVICES (Microservices) ---

        /**
         * URL Shortening Service (Write Path)
         * Handles creation of new short URLs.
         */
        async function urlShorteningService(longUrl, customAlias = null, expiryDays = null) {
            // a. Validation
            try {
                new URL(longUrl);
            } catch (_) {
                return { success: false, message: 'Invalid URL provided.' };
            }
            
            // In a real system, we would also check against a malicious URL blacklist (e.g., Google Safe Browsing API)
            
            let shortCode = customAlias;
            let isCustom = true;

            // b. Custom Alias Check
            if (customAlias) {
                if (!/^[a-zA-Z0-9_-]+$/.test(customAlias)) {
                    return { success: false, message: 'Custom alias can only contain letters, numbers, hyphens, and underscores.' };
                }
                if (db.urls.has(customAlias)) {
                    return { success: false, message: 'This custom alias is already taken.' };
                }
            } else {
                // c. ID Generation
                shortCode = generateShortCode();
                isCustom = false;
            }

            // d. Database Write
            const expiresAt = expiryDays ? new Date(Date.now() + expiryDays * 24 * 60 * 60 * 1000).toISOString() : null;
            
            const newRecord = {
                longUrl,
                createdAt: new Date().toISOString(),
                expiresAt,
                isCustom
            };
            
            db.urls.set(shortCode, newRecord);
            console.log('--- DB WRITE ---', { shortCode, ...newRecord });

            return {
                success: true,
                shortUrl: `${window.location.origin}${window.location.pathname}#${shortCode}`, // Using hash for client-side routing
                longUrl,
                expiresAt
            };
        }

        /**
         * URL Redirection Service (Read Path)
         * Handles lookup and redirection of short URLs.
         */
        async function urlRedirectionService(shortCode) {
            // a. Parse Request (already done)
            
            // b. Cache Lookup
            if (cache.has(shortCode)) {
                console.log(`--- CACHE HIT for ${shortCode} ---`);
                const cachedRecord = cache.get(shortCode);
                
                // Check for expiration even in cache
                if (cachedRecord.expiresAt && new Date(cachedRecord.expiresAt) < new Date()) {
                    // Expired: remove from cache and DB
                    cache.delete(shortCode);
                    db.urls.delete(shortCode);
                    return { success: false, message: 'This link has expired.' };
                }
                
                publishAnalyticsEvent(shortCode); // Publish analytics event
                return { success: true, longUrl: cachedRecord.longUrl };
            }
            
            console.log(`--- CACHE MISS for ${shortCode} ---`);
            
            // d. Cache Miss -> Database Lookup
            if (db.urls.has(shortCode)) {
                const dbRecord = db.urls.get(shortCode);
                
                // ii. Check for expiration
                if (dbRecord.expiresAt && new Date(dbRecord.expiresAt) < new Date()) {
                    db.urls.delete(shortCode); // Clean up expired link
                    return { success: false, message: 'This link has expired.' };
                }

                // iii. Update Cache
                cache.set(shortCode, dbRecord);
                console.log(`--- CACHE WRITE for ${shortCode} ---`);

                // iv. Publish analytics and return
                publishAnalyticsEvent(shortCode);
                return { success: true, longUrl: dbRecord.longUrl };
            } else {
                // v. DB Miss
                return { success: false, message: 'Short link not found.' };
            }
        }


        // --- FRONTEND LOGIC ---
        
        const longUrlInput = document.getElementById('longUrl');
        const customAliasInput = document.getElementById('customAlias');
        const expiryDaysInput = document.getElementById('expiryDays');
        const shortenBtn = document.getElementById('shortenBtn');
        const resultDiv = document.getElementById('result');

        // Function to display messages and results
        function showResult(html, isError = false) {
            resultDiv.innerHTML = html;
            resultDiv.className = `mt-8 p-4 rounded-lg fade-in ${isError ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`;
        }
        
        // Handle the shorten button click
        shortenBtn.addEventListener('click', async () => {
            const longUrl = longUrlInput.value.trim();
            const customAlias = customAliasInput.value.trim();
            const expiryDays = expiryDaysInput.value ? parseInt(expiryDaysInput.value) : null;

            if (!longUrl) {
                showResult('<p>Please enter a URL to shorten.</p>', true);
                return;
            }
            
            shortenBtn.disabled = true;
            shortenBtn.textContent = 'Shortening...';

            const result = await urlShorteningService(longUrl, customAlias, expiryDays);
            
            if (result.success) {
                const html = `
                    <p class="font-semibold">Success! Here is your short URL:</p>
                    <div class="mt-2 flex items-center justify-between bg-white p-3 rounded-lg border">
                        <a href="${result.shortUrl}" target="_blank" class="text-indigo-600 font-mono break-all">${result.shortUrl}</a>
                        <button onclick="copyToClipboard('${result.shortUrl}')" class="ml-4 px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 text-sm">Copy</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Original URL: <span class="font-mono break-all">${result.longUrl}</span></p>
                    ${result.expiresAt ? `<p class="text-xs text-gray-500 mt-1">Expires: ${new Date(result.expiresAt).toLocaleString()}</p>` : ''}
                `;
                showResult(html);
            } else {
                showResult(`<p>${result.message}</p>`, true);
            }
            
            shortenBtn.disabled = false;
            shortenBtn.textContent = 'Shorten URL';
        });

        // Function to copy text to clipboard
        function copyToClipboard(text) {
            // Using `execCommand` for broader compatibility in sandboxed environments
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                alert('Copied to clipboard!');
            } catch (err) {
                alert('Failed to copy.');
            }
            document.body.removeChild(textArea);
        }

        // Handle client-side redirection based on URL hash
        async function handleRedirect() {
            if (window.location.hash) {
                const shortCode = window.location.hash.substring(1);
                const result = await urlRedirectionService(shortCode);
                
                if (result.success) {
                    // In a real app, the server would send a 301 redirect.
                    // Here, we simulate it with client-side redirection.
                    showResult(`<p>Redirecting you to the original URL...</p>`);
                    setTimeout(() => {
                        window.location.href = result.longUrl;
                    }, 1500);
                } else {
                    showResult(`<p><strong>Error:</strong> ${result.message}</p>`, true);
                }
            }
        }
        
        // Listen for hash changes and initial page load
        window.addEventListener('hashchange', handleRedirect);
        window.addEventListener('load', handleRedirect);

    </script>
</body>
</html>